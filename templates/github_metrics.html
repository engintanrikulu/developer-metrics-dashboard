<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Metrics - Developer Dashboard</title>
    <link rel="icon" type="image/png" href="/static/favicon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/flatpickr.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/flatpickr.min.js"></script>
    <style>
        /* Sapphire Blue & Eggshell Color Palette */
        :root {
            --sapphire-blue: #0D47A1;
            --sapphire-secondary: #1565C0;
            --sapphire-light: #1976D2;
            --sapphire-accent: #2196F3;
            --eggshell: #FAFAFA;
            --eggshell-secondary: #F5F5F5;
            --eggshell-light: #F0F0F0;
            --eggshell-accent: #EEEEEE;
            --text-primary: #212121;
            --text-secondary: #757575;
            --text-muted: #90A4AE;
            --text-disabled: #BDBDBD;
            --success-blue: #1976D2;
            --warning-amber: #FFC107;
            --error-orange: #FF7043;
            --info-gray: #90A4AE;
            --card-bg: #FFFFFF;
            --border-color: #E0E0E0;
        }
        
        .navbar-brand {
            font-weight: bold;
        }
        .metric-card {
            transition: transform 0.2s;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(13, 71, 161, 0.15);
        }
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 2rem;
        }
        .loading {
            text-align: center;
            padding: 3rem;
        }
        .error-message {
            background-color: var(--accent-light);
            border: 1px solid var(--accent-color);
            color: var(--text-color);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-color);
        }
        .metric-label {
            font-size: 0.9rem;
            color: var(--text-light);
        }
        
        /* Modern Text Muted Override */
        .text-muted {
            color: var(--text-light) !important;
        }
        
        /* Consistent Icon Colors */
        .fab.fa-github.text-muted {
            color: var(--text-light) !important;
        }
        
        .fas.fa-spinner.text-muted {
            color: var(--text-light) !important;
        }
        
        /* Small Text and Labels */
        small.text-muted {
            color: var(--text-light) !important;
        }
        
        /* Loading and Info Text */
        .loading h4, .loading p {
            color: var(--text-light) !important;
        }
        
        /* Filter Toggle Styling */
        .filter-toggle-header {
            transition: all 0.2s ease;
        }
        
        .filter-toggle-header:hover {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            transform: translateY(-1px);
        }
        
        #filter-content {
            overflow: hidden;
        }
        
        .filter-status-compact {
            max-width: 400px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Modern Filter Cards */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        
        .card:hover {
            box-shadow: 0 8px 25px rgba(106, 27, 154, 0.15);
        }
        
        .card-header {
            background: var(--sapphire-blue);
            color: #FFFFFF;
            border-bottom: 2px solid var(--sapphire-secondary);
        }
        
        .card-body {
            background: var(--card-bg);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--sapphire-secondary) 0%, var(--sapphire-blue) 100%) !important;
            border: none !important;
            color: #FFFFFF !important;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--sapphire-blue) 0%, var(--sapphire-secondary) 100%) !important;
            box-shadow: 0 4px 12px rgba(13, 71, 161, 0.3);
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--eggshell-accent) 0%, var(--eggshell-light) 100%) !important;
            border: none !important;
            color: var(--text-primary) !important;
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, var(--eggshell-light) 0%, var(--eggshell-accent) 100%) !important;
            box-shadow: 0 4px 12px rgba(144, 164, 174, 0.3);
        }
        
        .text-primary {
            color: var(--sapphire-secondary) !important;
        }
        
        .text-success {
            color: var(--success-blue) !important;
        }
        
        .text-warning {
            color: var(--warning-color) !important;
        }
        
        .text-info {
            color: var(--info-border) !important;
        }
        
        .badge.bg-light {
            background-color: var(--eggshell-secondary) !important;
            color: var(--sapphire-blue) !important;
            border: 1px solid var(--border-color);
        }
        
        /* Modern Filter Cards */
        .filter-card {
            transition: all 0.3s ease;
            border-radius: 12px;
            background: linear-gradient(135deg, #FAFAFA 0%, #F5F5F5 100%);
            border: 2px solid #E0E0E0;
        }
        .filter-card.active {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 0.2rem rgba(106, 27, 154, 0.25);
            transform: translateY(-2px);
            background: linear-gradient(135deg, var(--card-bg) 0%, var(--secondary-bg) 100%);
        }
        .filter-card.active .card-header {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }
        .filter-card.active .card-header h6 {
            color: #FFFFFF !important;
        }
        .filter-card.inactive {
            opacity: 0.6;
        }
        .active-badge {
            position: absolute;
            top: -8px;
            right: 10px;
            background: var(--primary-color);
            color: #FFFFFF;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        /* Sapphire Blue Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--sapphire-secondary) 0%, var(--sapphire-blue) 100%) !important;
            border: none !important;
            color: #FFFFFF !important;
            font-weight: 600;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--sapphire-blue) 0%, var(--sapphire-secondary) 100%) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(13, 71, 161, 0.3);
        }
        
        .btn-outline-secondary {
            background: var(--eggshell) !important;
            border: 2px solid var(--sapphire-secondary) !important;
            color: var(--sapphire-secondary) !important;
            font-weight: 600;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            transition: all 0.2s ease;
        }
        
        .btn-outline-secondary:hover {
            background: var(--sapphire-secondary) !important;
            color: #FFFFFF !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-blue) 0%, var(--sapphire-blue) 100%) !important;
            border: none !important;
            color: #FFFFFF !important;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, var(--sapphire-blue) 0%, var(--success-blue) 100%) !important;
        }
        
        /* Modern Design System */
        .modern-table-card {
            border-radius: 12px;
            background: linear-gradient(135deg, var(--secondary-bg) 0%, #F0F0F0 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: none;
            overflow: hidden;
            margin-bottom: 2rem;
        }
        
        .modern-table-header {
            background: var(--sapphire-blue);
            color: #FFFFFF;
            padding: 1.25rem;
            border-bottom: none;
        }
        
        .modern-table-header h5 {
            margin: 0;
            font-weight: 600;
            font-size: 1.1rem;
            color: #FFFFFF;
        }
        
        .modern-table-header small {
            opacity: 0.9;
            font-size: 0.85rem;
            color: #FFFFFF;
        }
        
        .modern-table {
            margin: 0;
            background: #FFFFFF;
        }
        
        .modern-table th {
            background-color: var(--sapphire-blue);
            border-bottom: 2px solid var(--sapphire-secondary);
            color: #FFFFFF;
            font-weight: 600;
            font-size: 0.875rem;
            padding: 1rem 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        .modern-table td {
            padding: 1rem 0.75rem;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            background-color: var(--card-bg);
        }
        
        .modern-table tbody tr {
            transition: all 0.2s ease;
        }
        
        .modern-table tbody tr:nth-child(even) {
            background-color: var(--eggshell-secondary);
        }
        
        .modern-table tbody tr:nth-child(even) td {
            background-color: var(--eggshell-secondary);
        }
        
        .modern-table tbody tr:nth-child(odd) td {
            background-color: var(--eggshell-light);
        }
        
        .modern-table tbody tr:hover {
            background-color: var(--eggshell-accent);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(13, 71, 161, 0.15);
        }
        
        .modern-table tbody tr:hover td {
            background-color: var(--eggshell-accent);
        }
        
        /* Modern Badges */
        .metric-badge {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            border: none;
        }
        
        .metric-badge.high {
            background-color: var(--success-blue);
            color: #FFFFFF;
        }
        
        .metric-badge.medium {
            background-color: var(--warning-amber);
            color: #000000;
        }
        
        .metric-badge.low {
            background-color: var(--text-muted);
            color: #FFFFFF;
        }
        
        .metric-badge.neutral {
            background-color: var(--sapphire-secondary);
            color: #FFFFFF;
        }
        
        /* Modern Cards */
        .card {
            border-radius: 12px;
            background: linear-gradient(135deg, var(--eggshell-secondary) 0%, #F0F0F0 100%);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background: var(--sapphire-blue);
            color: #FFFFFF;
            border-bottom: 2px solid var(--sapphire-secondary);
            border-radius: 12px 12px 0 0 !important;
        }
        
        .card-header h5, .card-header h6 {
            color: #FFFFFF;
        }
        
        .card-body {
            background: var(--card-bg);
        }
        
        /* Modern Metric Cards */
        .metric-card {
            border-radius: 12px;
            background: linear-gradient(135deg, var(--secondary-bg) 0%, #F0F0F0 100%);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(106, 27, 154, 0.15);
        }
        
        .metric-value {
            font-weight: 700;
            font-size: 2rem;
        }
        
        /* Bootstrap Badge Overrides */
        .badge.bg-primary {
            background-color: var(--sapphire-blue) !important;
        }
        
        .badge.bg-success {
            background-color: var(--success-blue) !important;
        }
        
        .badge.bg-info {
            background-color: var(--text-muted) !important;
        }
        
        .badge.bg-warning {
            background-color: var(--warning-amber) !important;
            color: #000000 !important;
        }
        
        .badge.bg-danger {
            background-color: var(--error-orange) !important;
        }
        
        .badge.bg-secondary {
            background-color: var(--text-muted) !important;
        }
        
        /* Mobile responsive table with Sapphire Blue & Eggshell */
        @media (max-width: 768px) {
            .mobile-stack {
                display: block;
            }
            
            .mobile-stack thead {
                display: none;
            }
            
            .mobile-stack tbody,
            .mobile-stack tr,
            .mobile-stack td {
                display: block;
                width: 100%;
            }
            
            .mobile-stack tr {
                border: 2px solid #E0E0E0;
                margin-bottom: 1rem;
                border-radius: 12px;
                padding: 1rem;
                background: linear-gradient(135deg, #FAFAFA 0%, #F5F5F5 100%);
                box-shadow: 0 2px 8px rgba(13, 71, 161, 0.1);
            }
            
            .mobile-stack td {
                border: none;
                padding: 0.5rem 0;
                text-align: left;
                background: transparent !important;
            }
            
            .mobile-stack td:before {
                content: attr(data-label) ": ";
                font-weight: 600;
                color: var(--sapphire-blue);
            }
        }
        
        /* Collapsible Repository Cards Styling */
        .accordion .card {
            border: none;
            border-radius: 12px !important;
            overflow: hidden;
        }
        
        .accordion .card .btn-link {
            border: none;
            box-shadow: none;
            transition: all 0.3s ease;
        }
        
        .accordion .card .btn-link:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            transform: none;
        }
        
        .accordion .card .btn-link:focus {
            box-shadow: none;
        }
        
        .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 0.9rem;
        }
        
        .collapse {
            transition: height 0.35s ease;
        }
        
        /* Expand/Collapse All Buttons */
        .modern-table-header .btn-outline-primary {
            background: rgba(255, 255, 255, 0.1) !important;
            border: 2px solid rgba(255, 255, 255, 0.3) !important;
            color: #FFFFFF !important;
            transition: all 0.2s ease;
        }
        
        .modern-table-header .btn-outline-primary:hover {
            background: rgba(255, 255, 255, 0.2) !important;
            border-color: rgba(255, 255, 255, 0.5) !important;
            color: #FFFFFF !important;
            transform: translateY(-1px);
        }
        
        .modern-table-header .btn-outline-secondary {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 2px solid rgba(255, 255, 255, 0.2) !important;
            color: rgba(255, 255, 255, 0.8) !important;
            transition: all 0.2s ease;
        }
        
        .modern-table-header .btn-outline-secondary:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.4) !important;
            color: #FFFFFF !important;
            transform: translateY(-1px);
        }
        
        /* Mobile adjustments for repository cards */
        @media (max-width: 768px) {
            .accordion .card .btn-link {
                padding: 1rem !important;
            }
            
            .accordion .card h6 {
                font-size: 0.95rem;
            }
            
            .accordion .card small {
                font-size: 0.8rem;
            }
            
            .d-flex.gap-2 {
                gap: 0.5rem !important;
            }
            
            .btn-sm {
                padding: 0.375rem 0.75rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line me-2"></i>
                Developer Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/github">GitHub Metrics</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/team-comparison">Team Comparison</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="alert('Jira metrics coming soon!')">Jira Metrics</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/documentation">
                            <i class="fas fa-info-circle me-1"></i>
                            Documentation
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>



    <!-- Sapphire Blue Header -->
    <div class="py-4" style="background: linear-gradient(135deg, var(--sapphire-blue) 0%, var(--sapphire-secondary) 100%); color: #FFFFFF;">
        <div class="container">
            <h1 class="display-6 mb-0" style="color: #FFFFFF;">
                <i class="fab fa-github me-3"></i>
                GitHub Metrics - {{ team_name }}
                <a href="/github-metrics" class="btn btn-sm ms-3" style="background: var(--eggshell); border: 2px solid #FFFFFF; color: var(--sapphire-blue); font-weight: 600; border-radius: 8px;">
                    <i class="fas fa-arrow-left me-2"></i>
                    Back to Teams
                </a>
            </h1>
            <p class="lead mb-2" style="color: #FFFFFF; opacity: 0.9;">Repository performance and development workflow insights</p>
            {% if overall_date_range and overall_date_range.has_data %}
                <p class="mb-0" style="color: #FFFFFF; opacity: 0.9;">
                    <i class="fas fa-calendar-alt me-2"></i>
                    <span id="date-range-display">Data Range: {{ overall_date_range.formatted_range }}</span>
                    <small class="ms-2" id="date-range-days">({{ overall_date_range.total_days }} days)</small>
                </p>
            {% else %}
                <p class="mb-0" style="color: #FFFFFF; opacity: 0.9;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="date-range-display">{{ overall_date_range.formatted_range if overall_date_range else 'No data available' }}</span>
                </p>
            {% endif %}
        </div>
    </div>

    <!-- Main Content -->
    <div class="container my-5">
        {% if error %}
            <div class="error-message">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Error:</strong> {{ error }}
            </div>
        {% endif %}

        {% if metrics %}
            <!-- Date Range Filters - Collapsible -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card modern-table-card">
                        <div class="card-header modern-table-header filter-toggle-header d-flex justify-content-between align-items-center" style="cursor: pointer;" onclick="toggleFilters()">
                            <div>
                                <h5 class="card-title mb-1">
                                    <i class="fas fa-filter me-2"></i>
                                    📅 Date Range Filters
                                    <span class="badge bg-light text-dark ms-2" id="filter-count">Optional</span>
                                </h5>
                                <small id="current-filter-status" class="filter-status-compact">
                                    {% if overall_date_range and overall_date_range.filter_description %}
                                        Active: {{ overall_date_range.filter_description }}
                                    {% else %}
                                        Click to show filtering options
                                    {% endif %}
                                </small>
                            </div>
                            <div>
                                <i class="fas fa-chevron-down" id="filter-toggle-icon" style="transition: transform 0.3s ease;"></i>
                            </div>
                        </div>
                        <div class="card-body" id="filter-content" style="display: none; transition: all 0.3s ease;">
                            <!-- Filter Status -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div id="filter-status" class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <span id="filter-description">
                                            {% if overall_date_range and overall_date_range.filter_description %}
                                                Showing metrics for: {{ overall_date_range.filter_description }}
                                            {% else %}
                                                Showing all available data (last 20 PRs per repository)
                                            {% endif %}
                                        </span>
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                <i class="fas fa-lightbulb me-1"></i>
                                                <strong>Tip:</strong> Selecting a new filter automatically clears the previous one.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Date Range Picker -->
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="card border-primary filter-card" id="custom-range-card">
                                        <div class="card-header bg-primary text-white position-relative">
                                            <h6 class="mb-0">
                                                <i class="fas fa-calendar-day me-2"></i>
                                                Custom Date Range
                                            </h6>
                                            <span class="active-badge" id="custom-range-badge" style="display: none;">
                                                <i class="fas fa-check me-1"></i>Active
                                            </span>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="start-date" class="form-label">Start Date</label>
                                                    <input type="text" class="form-control" id="start-date" placeholder="Select start date">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label for="end-date" class="form-label">End Date</label>
                                                    <input type="text" class="form-control" id="end-date" placeholder="Select end date">
                                                </div>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-primary" onclick="applyDateFilter()">
                                                    <i class="fas fa-filter me-2"></i>
                                                    Apply Filter
                                                </button>
                                                <button class="btn btn-outline-secondary" onclick="clearDateFilter()">
                                                    <i class="fas fa-times me-2"></i>
                                                    Clear Filter
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-lg-6">
                                                        <div class="card border-primary filter-card" id="month-selector-card">
                        <div class="card-header bg-primary text-white position-relative">
                            <h6 class="mb-0">
                                <i class="fas fa-calendar-check me-2"></i>
                                Quick Month Selection
                            </h6>
                            <span class="active-badge" id="month-selector-badge" style="display: none;">
                                <i class="fas fa-check me-1"></i>Active
                            </span>
                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="month-selector" class="form-label">Select Month</label>
                                                <select class="form-select" id="month-selector">
                                                    <option value="">-- Select a month --</option>
                                                </select>
                                            </div>
                                            <div class="d-flex gap-2">
                                                                                <button class="btn btn-primary" onclick="applyMonthFilter()">
                                    <i class="fas fa-calendar-alt me-2"></i>
                                    Apply Month
                                </button>
                                                <button class="btn btn-outline-secondary" onclick="clearMonthFilter()">
                                                    <i class="fas fa-times me-2"></i>
                                                    Clear
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Loading State -->
                            <div id="loading-overlay" class="text-center mt-3" style="display: none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div class="mt-2">
                                    <strong>Loading filtered metrics...</strong>
                                    <div class="text-muted">Please wait while we fetch your data</div>
                                </div>
                            </div>
                            
                            <!-- Enhanced Loading State for Parallel Processing -->
                            <div id="parallel-loading-overlay" class="text-center mt-3" style="display: none;">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-12 mb-3">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <h5 class="mt-2 mb-1">Fetching Repository Data</h5>
                                                <p class="text-muted mb-0">Processing repositories in parallel for optimal performance</p>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-lg-4 mb-3">
                                                <div class="card bg-light">
                                                    <div class="card-body p-3">
                                                        <h6 class="card-title mb-2">
                                                            <i class="fas fa-rocket text-primary me-2"></i>
                                                            Optimized Fetching
                                                        </h6>
                                                        <small class="text-muted">Using parallel processing for faster data retrieval</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-4 mb-3">
                                                <div class="card bg-light">
                                                    <div class="card-body p-3">
                                                        <h6 class="card-title mb-2">
                                                            <i class="fas fa-database text-success me-2"></i>
                                                            Smart Caching
                                                        </h6>
                                                        <small class="text-muted">Leveraging cache for improved performance</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-lg-4 mb-3">
                                                <div class="card bg-light">
                                                    <div class="card-body p-3">
                                                        <h6 class="card-title mb-2">
                                                            <i class="fas fa-shield-alt text-warning me-2"></i>
                                                            Rate Limiting
                                                        </h6>
                                                        <small class="text-muted">Respecting GitHub API limits</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Summary Cards -->
            <div class="row mb-5">
                <div class="col-md-4 mb-3">
                    <div class="card metric-card">
                        <div class="card-body text-center">
                            <i class="fas fa-code-branch fa-2x text-primary mb-3"></i>
                            <div class="metric-value text-primary">{{ "%.1f"|format(metrics|sum(attribute='pr_throughput')) }}</div>
                            <div class="metric-label">Total PRs/Day</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card metric-card">
                        <div class="card-body text-center">
                            <i class="fas fa-clock fa-2x text-primary mb-3"></i>
                            <div class="metric-value text-primary">{{ "%.1f"|format(metrics|sum(attribute='mr_time')/metrics|length) }}h</div>
                            <div class="metric-label">Avg MR Time</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card metric-card">
                        <div class="card-body text-center">
                            <i class="fas fa-stopwatch fa-2x text-info mb-3"></i>
                            <div class="metric-value text-info">{{ "%.1f"|format(metrics|sum(attribute='first_commit_to_merge')/metrics|length) }}h</div>
                            <div class="metric-label">Avg Commit to Merge</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Team Comparison Card -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-users me-2"></i>
                                🏆 Compare with Other Teams
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <p class="mb-2">
                                        <strong>Want to see how {{ team_name }} performs against other teams?</strong>
                                    </p>
                                    <p class="text-muted mb-0">
                                        View comprehensive team rankings, global contributor leaderboards, and monthly performance trends across all development teams.
                                    </p>
                                    <small class="text-primary">
                                        <i class="fas fa-info-circle me-1"></i>
                                        <strong>Quick Navigation:</strong> Direct access to team comparison dashboard
                                    </small>
                                </div>
                                <div class="col-md-4 text-md-end">
                                    <a href="/team-comparison" class="btn btn-primary btn-lg" onclick="navigateToTeamComparison(event)">
                                        <i class="fas fa-balance-scale me-2"></i>
                                        Compare Teams
                                    </a>
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="fas fa-rocket me-1"></i>
                                            Instant navigation
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cache Status -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-database me-2"></i>
                                Cache Status
                            </h6>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearCache()">
                                <i class="fas fa-trash me-1"></i>Clear {{ team_name }} Cache
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <small class="text-muted">Total Items:</small>
                                    <span id="cache-size" class="badge bg-info ms-2">Loading...</span>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">TTL:</small>
                                    <span id="cache-ttl" class="badge bg-success ms-2">12 Hours</span>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Repo Metrics:</small>
                                    <span id="cache-repo-metrics" class="badge bg-primary ms-2">0</span>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">{{ team_name }} Cache:</small>
                                    <span id="cache-team-cache" class="badge bg-secondary ms-2">0</span>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-3">
                                    <small class="text-muted">PRs:</small>
                                    <span id="cache-prs" class="badge bg-warning ms-2">0</span>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">All Reviews:</small>
                                    <span id="cache-all-reviews" class="badge bg-info ms-2">0</span>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">All Commits:</small>
                                    <span id="cache-all-commits" class="badge bg-success ms-2">0</span>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Rate Limit:</small>
                                    <span id="cache-rate-limit" class="badge bg-danger ms-2">0</span>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-3">
                                    <small class="text-muted">Detailed PRs:</small>
                                    <span id="cache-detailed-prs" class="badge bg-purple ms-2">0</span>
                                </div>
                                <div class="col-md-9">
                                    <small class="text-muted">Cache helps reduce API calls by 97% with 12-hour TTL</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Repository Metrics Table -->
            <div class="row mb-5">
                <div class="col-12">
                    <div class="card modern-table-card">
                        <div class="card-header modern-table-header">
                            <h5 class="card-title mb-1">
                                <i class="fas fa-database me-2"></i>
                                📊 Repository Metrics Summary
                            </h5>
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                Comprehensive metrics based on closed PRs from each repository
                            </small>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table modern-table mobile-stack">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-code-branch me-1"></i> Repository</th>
                                            <th><i class="fas fa-calendar me-1"></i> Data Range</th>
                                            <th><i class="fas fa-chart-line me-1"></i> PR Throughput</th>
                                            <th><i class="fas fa-clock me-1"></i> MR Time</th>
                                            <th><i class="fas fa-stopwatch me-1"></i> Commit to Merge</th>
                                            <th><i class="fas fa-hashtag me-1"></i> Total PRs</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for metric in metrics %}
                                            <tr>
                                                <td data-label="Repository">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fab fa-github me-2 text-muted"></i>
                                                        <div>
                                                            <strong>{{ metric.repository }}</strong>
                                                            {% if metric.error %}
                                                                <br><small class="text-danger">
                                                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                                                    Error: {{ metric.error }}
                                                                </small>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </td>
                                                <td data-label="Data Range">
                                                    {% if metric.date_range and metric.date_range.has_data %}
                                                        <small class="text-muted">
                                                            <i class="fas fa-calendar-alt me-1"></i>
                                                            {{ metric.date_range.formatted_range }}
                                                            <br>
                                                            <span class="badge bg-light text-dark">{{ metric.date_range.total_days }} days</span>
                                                        </small>
                                                    {% else %}
                                                        <small class="text-muted">{{ metric.date_range.formatted_range if metric.date_range else 'No data' }}</small>
                                                    {% endif %}
                                                </td>
                                                <td data-label="PR Throughput">
                                                    {% set throughput = metric.pr_throughput %}
                                                    {% if throughput >= 1 %}
                                                        <span class="metric-badge high">{{ "%.2f"|format(throughput) }}/day</span>
                                                    {% elif throughput >= 0.5 %}
                                                        <span class="metric-badge medium">{{ "%.2f"|format(throughput) }}/day</span>
                                                    {% else %}
                                                        <span class="metric-badge low">{{ "%.2f"|format(throughput) }}/day</span>
                                                    {% endif %}
                                                </td>
                                                <td data-label="MR Time">
                                                    {% set mr_time = metric.mr_time %}
                                                    {% if mr_time <= 4 %}
                                                        <span class="metric-badge high">{{ "%.1f"|format(mr_time) }}h</span>
                                                    {% elif mr_time <= 24 %}
                                                        <span class="metric-badge medium">{{ "%.1f"|format(mr_time) }}h</span>
                                                    {% else %}
                                                        <span class="metric-badge low">{{ "%.1f"|format(mr_time) }}h</span>
                                                    {% endif %}
                                                </td>
                                                <td data-label="Commit to Merge">
                                                    {% set commit_time = metric.first_commit_to_merge %}
                                                    {% if commit_time <= 24 %}
                                                        <span class="metric-badge high">{{ "%.1f"|format(commit_time) }}h</span>
                                                    {% elif commit_time <= 72 %}
                                                        <span class="metric-badge medium">{{ "%.1f"|format(commit_time) }}h</span>
                                                    {% else %}
                                                        <span class="metric-badge low">{{ "%.1f"|format(commit_time) }}h</span>
                                                    {% endif %}
                                                </td>
                                                <td data-label="Total PRs">
                                                    {% set total_prs = metric.total_prs %}
                                                    {% if total_prs >= 20 %}
                                                        <span class="metric-badge high">{{ total_prs }}</span>
                                                    {% elif total_prs >= 10 %}
                                                        <span class="metric-badge medium">{{ total_prs }}</span>
                                                    {% elif total_prs > 0 %}
                                                        <span class="metric-badge neutral">{{ total_prs }}</span>
                                                    {% else %}
                                                        <span class="metric-badge low">{{ total_prs }}</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Team-Level Top PR Contributors Leaderboard -->
            {% if team_leaderboard %}
            <div class="row mb-5">
                <div class="col-12">
                    <div class="card modern-table-card">
                        <div class="card-header modern-table-header">
                            <h5 class="card-title mb-1">
                                <i class="fas fa-crown me-2"></i>
                                🏆 {{ team_name }} Team - Top PR Contributors
                            </h5>
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                Aggregated performance across all repositories in the team
                            </small>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table modern-table mobile-stack">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-medal me-1"></i> Rank</th>
                                            <th><i class="fas fa-user me-1"></i> Developer</th>
                                            <th><i class="fas fa-code-branch me-1"></i> Total PRs</th>
                                            <th><i class="fas fa-chart-line me-1"></i> Lines Changed</th>
                                            <th><i class="fas fa-calculator me-1"></i> Avg PR Size</th>
                                            <th><i class="fas fa-folder me-1"></i> Repositories</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for contributor in team_leaderboard %}
                                            <tr>
                                                <td data-label="Rank">
                                                    {% if loop.index == 1 %}
                                                        <span class="badge bg-warning text-dark px-3 py-2">
                                                            <i class="fas fa-trophy me-1"></i>
                                                            #{{ loop.index }}
                                                        </span>
                                                    {% elif loop.index == 2 %}
                                                        <span class="badge bg-secondary px-3 py-2">
                                                            <i class="fas fa-medal me-1"></i>
                                                            #{{ loop.index }}
                                                        </span>
                                                    {% elif loop.index == 3 %}
                                                        <span class="badge bg-dark px-3 py-2">
                                                            <i class="fas fa-medal me-1"></i>
                                                            #{{ loop.index }}
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-light text-dark px-3 py-2">
                                                            #{{ loop.index }}
                                                        </span>
                                                    {% endif %}
                                                </td>
                                                <td data-label="Developer">
                                                    <div class="d-flex align-items-center">
                                                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                                            <i class="fas fa-user text-white" style="font-size: 0.8rem;"></i>
                                                        </div>
                                                        <span class="fw-bold">{{ contributor.username }}</span>
                                                    </div>
                                                </td>
                                                <td data-label="Total PRs">
                                                    {% set total_prs = contributor.total_prs %}
                                                    {% if total_prs >= 50 %}
                                                        <span class="metric-badge high">{{ total_prs }}</span>
                                                    {% elif total_prs >= 20 %}
                                                        <span class="metric-badge medium">{{ total_prs }}</span>
                                                    {% else %}
                                                        <span class="metric-badge neutral">{{ total_prs }}</span>
                                                    {% endif %}
                                                </td>
                                                <td data-label="Lines Changed">
                                                    <div class="d-flex flex-column">
                                                        <div class="mb-1">
                                                            <span class="badge bg-success me-1">+{{ "{:,}".format(contributor.total_additions) }}</span>
                                                            <span class="badge bg-danger">-{{ "{:,}".format(contributor.total_deletions) }}</span>
                                                        </div>
                                                        <div>
                                                            {% set lines_changed = contributor.total_lines_changed %}
                                                            {% if lines_changed >= 10000 %}
                                                                <span class="metric-badge high">{{ "{:,}".format(lines_changed) }}</span>
                                                            {% elif lines_changed >= 5000 %}
                                                                <span class="metric-badge medium">{{ "{:,}".format(lines_changed) }}</span>
                                                            {% else %}
                                                                <span class="metric-badge neutral">{{ "{:,}".format(lines_changed) }}</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </td>
                                                <td data-label="Avg PR Size">
                                                    {% set avg_size = contributor.avg_pr_size %}
                                                    {% if avg_size >= 500 %}
                                                        <span class="metric-badge medium">{{ "{:,}".format(avg_size) }} lines</span>
                                                    {% elif avg_size >= 100 %}
                                                        <span class="metric-badge high">{{ "{:,}".format(avg_size) }} lines</span>
                                                    {% else %}
                                                        <span class="metric-badge neutral">{{ "{:,}".format(avg_size) }} lines</span>
                                                    {% endif %}
                                                </td>
                                                <td data-label="Repositories">
                                                    <div class="d-flex flex-column">
                                                        <div class="mb-1">
                                                            {% set repo_count = contributor.repositories_count %}
                                                            {% if repo_count >= 4 %}
                                                                <span class="metric-badge high">{{ repo_count }} repos</span>
                                                            {% elif repo_count >= 2 %}
                                                                <span class="metric-badge medium">{{ repo_count }} repos</span>
                                                            {% else %}
                                                                <span class="metric-badge neutral">{{ repo_count }} repo</span>
                                                            {% endif %}
                                                        </div>
                                                        <small class="text-muted">
                                                            {{ contributor.repositories|join(', ') }}
                                                        </small>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-light">
                            <small class="text-muted">
                                <i class="fas fa-chart-bar me-1"></i>
                                Showing top {{ team_leaderboard|length }} contributors ranked by total PR count across all team repositories
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Top 5 Highest MR Times -->
            {% if top_5_mr_times %}
            <div class="row mb-5">
                <div class="col-12">
                    <div class="card modern-table-card">
                        <div class="card-header modern-table-header">
                            <h5 class="card-title mb-1">
                                <i class="fas fa-clock me-2"></i>
                                ⏰ Top 5 Highest MR Times
                            </h5>
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                Pull requests with the longest time from creation to first review
                            </small>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table modern-table mobile-stack">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-code-branch me-1"></i> Repository</th>
                                            <th><i class="fas fa-hashtag me-1"></i> PR #</th>
                                            <th><i class="fas fa-file-alt me-1"></i> Title</th>
                                            <th><i class="fas fa-user me-1"></i> Author</th>
                                            <th><i class="fas fa-calendar-plus me-1"></i> Created</th>
                                            <th><i class="fas fa-eye me-1"></i> First Review</th>
                                            <th><i class="fas fa-clock me-1"></i> MR Time</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for pr in top_5_mr_times %}
                                            <tr>
                                                <td data-label="Repository">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fab fa-github me-2 text-muted"></i>
                                                        <strong>{{ pr.repository }}</strong>
                                                    </div>
                                                </td>
                                                <td data-label="PR #">
                                                    <a href="{{ pr.pr_url }}" target="_blank" class="text-decoration-none">
                                                        <span class="badge bg-primary">#{{ pr.pr_number }}</span>
                                                    </a>
                                                </td>
                                                <td data-label="Title">
                                                    <a href="{{ pr.pr_url }}" target="_blank" class="text-decoration-none">
                                                        <span class="fw-bold">{{ pr.pr_title[:50] }}{% if pr.pr_title|length > 50 %}...{% endif %}</span>
                                                    </a>
                                                </td>
                                                <td data-label="Author">
                                                    <div class="d-flex align-items-center">
                                                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 24px; height: 24px;">
                                                            <i class="fas fa-user text-white" style="font-size: 0.6rem;"></i>
                                                        </div>
                                                        <span>{{ pr.author }}</span>
                                                    </div>
                                                </td>
                                                <td data-label="Created">
                                                    <small class="text-muted">
                                                        <i class="fas fa-calendar me-1"></i>
                                                        {{ pr.created_at[:10] }}
                                                    </small>
                                                </td>
                                                <td data-label="First Review">
                                                    <small class="text-muted">
                                                        <i class="fas fa-calendar-check me-1"></i>
                                                        {{ pr.first_review_at[:10] }}
                                                    </small>
                                                </td>
                                                <td data-label="MR Time">
                                                    {% set mr_time = pr.mr_time_hours %}
                                                    {% if mr_time >= 48 %}
                                                        <span class="metric-badge low">{{ "%.1f"|format(mr_time) }}h</span>
                                                    {% elif mr_time >= 24 %}
                                                        <span class="metric-badge medium">{{ "%.1f"|format(mr_time) }}h</span>
                                                    {% else %}
                                                        <span class="metric-badge neutral">{{ "%.1f"|format(mr_time) }}h</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- PR Contributors Leaderboard -->
            {% if metrics %}
            <div class="row mb-5">
                <div class="col-12">
                    <!-- Section Header with Expand/Collapse All Controls -->
                    <div class="card modern-table-card mb-3">
                        <div class="card-header modern-table-header d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title mb-1">
                                    <i class="fas fa-trophy me-2"></i>
                                    👤 Top PR Contributors by Repository
                                </h5>
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    Leading contributors ranked by PR count and code impact per repository
                                </small>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="expandAllRepos()">
                                    <i class="fas fa-expand-alt me-1"></i>
                                    Expand All
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="collapseAllRepos()">
                                    <i class="fas fa-compress-alt me-1"></i>
                                    Collapse All
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Collapsible Repository Cards -->
                    <div class="accordion" id="repoContributorsAccordion">
                        {% for metric in metrics %}
                            <div class="card modern-table-card mb-3">
                                <div class="card-header modern-table-header p-0">
                                    <button class="btn btn-link text-white text-decoration-none w-100 d-flex justify-content-between align-items-center p-3" 
                                            type="button" 
                                            data-bs-toggle="collapse" 
                                            data-bs-target="#repoCollapse{{ loop.index }}" 
                                            aria-expanded="{% if loop.index <= 2 %}true{% else %}false{% endif %}" 
                                            aria-controls="repoCollapse{{ loop.index }}"
                                            onclick="toggleRepoIcon({{ loop.index }})">
                                        <div class="d-flex align-items-center">
                                            <i class="fab fa-github me-3"></i>
                                            <div class="text-start">
                                                <h6 class="mb-1 text-white">{{ metric.repository }}</h6>
                                                <small class="text-white-50">
                                                    {% if metric.leaderboard %}
                                                        {{ metric.leaderboard|length }} contributor{{ 's' if metric.leaderboard|length != 1 else '' }}
                                                    {% else %}
                                                        No contributor data
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>
                                        <i class="fas fa-chevron-{% if loop.index <= 2 %}up{% else %}down{% endif %} toggle-icon" id="repoIcon{{ loop.index }}"></i>
                                    </button>
                                </div>
                                
                                <div id="repoCollapse{{ loop.index }}" 
                                     class="collapse {% if loop.index <= 2 %}show{% endif %}" 
                                     aria-labelledby="repoHeading{{ loop.index }}" 
                                     data-bs-parent="#repoContributorsAccordion">
                                    <div class="card-body p-0">
                                        {% if metric.leaderboard %}
                                            <div class="table-responsive">
                                                <table class="table modern-table mobile-stack mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th><i class="fas fa-user me-1"></i> Developer</th>
                                                            <th class="text-center"><i class="fas fa-hashtag me-1"></i> Total PRs</th>
                                                            <th class="text-center"><i class="fas fa-chart-bar me-1"></i> Avg PR Size</th>
                                                            <th class="text-center"><i class="fas fa-code me-1"></i> Lines Changed</th>
                                                            <th class="text-center"><i class="fas fa-plus-circle me-1"></i> Additions</th>
                                                            <th class="text-center"><i class="fas fa-minus-circle me-1"></i> Deletions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for contributor in metric.leaderboard %}
                                                            <tr>
                                                                <td data-label="Developer">
                                                                    <div class="d-flex align-items-center">
                                                                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                                                            <i class="fas fa-user text-white" style="font-size: 0.8rem;"></i>
                                                                        </div>
                                                                        <span class="fw-bold">{{ contributor.username }}</span>
                                                                    </div>
                                                                </td>
                                                                <td data-label="Total PRs" class="text-center">
                                                                    {% set total_prs = contributor.total_prs %}
                                                                    {% if total_prs >= 15 %}
                                                                        <span class="metric-badge high">{{ total_prs }}</span>
                                                                    {% elif total_prs >= 5 %}
                                                                        <span class="metric-badge medium">{{ total_prs }}</span>
                                                                    {% else %}
                                                                        <span class="metric-badge neutral">{{ total_prs }}</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td data-label="Avg PR Size" class="text-center">
                                                                    {% set avg_size = contributor.avg_pr_size %}
                                                                    {% if avg_size >= 500 %}
                                                                        <span class="metric-badge medium">{{ avg_size }} lines</span>
                                                                    {% elif avg_size >= 100 %}
                                                                        <span class="metric-badge high">{{ avg_size }} lines</span>
                                                                    {% else %}
                                                                        <span class="metric-badge neutral">{{ avg_size }} lines</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td data-label="Lines Changed" class="text-center">
                                                                    {% set lines_changed = contributor.total_lines_changed %}
                                                                    {% if lines_changed >= 5000 %}
                                                                        <span class="metric-badge high">{{ "{:,}".format(lines_changed) }}</span>
                                                                    {% elif lines_changed >= 1000 %}
                                                                        <span class="metric-badge medium">{{ "{:,}".format(lines_changed) }}</span>
                                                                    {% else %}
                                                                        <span class="metric-badge neutral">{{ "{:,}".format(lines_changed) }}</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td data-label="Additions" class="text-center">
                                                                    <span class="badge bg-success">+{{ "{:,}".format(contributor.total_additions) }}</span>
                                                                </td>
                                                                <td data-label="Deletions" class="text-center">
                                                                    <span class="badge bg-danger">-{{ "{:,}".format(contributor.total_deletions) }}</span>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <div class="p-4 text-center text-muted">
                                                <i class="fas fa-exclamation-circle me-2"></i>
                                                No contributor data available for this repository
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Weekly PR Counts -->
            {% if metrics %}
            <div class="row mb-5">
                <div class="col-12">
                    <div class="card modern-table-card">
                        <div class="card-header modern-table-header">
                            <h5 class="card-title mb-1">
                                <i class="fas fa-calendar-week me-2"></i>
                                📅 Weekly PR Activity (Last 4 Weeks)
                            </h5>
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                Weekly trend analysis showing created vs merged PRs by repository
                            </small>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table modern-table mobile-stack">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-code-branch me-1"></i> Repository</th>
                                            {% if metrics[0].weekly_counts %}
                                                {% for week in metrics[0].weekly_counts %}
                                                    <th class="text-center">
                                                        <i class="fas fa-calendar-day me-1"></i>
                                                        {{ week.week_label }}
                                                        <br><small class="text-muted">Created / Merged</small>
                                                    </th>
                                                {% endfor %}
                                            {% endif %}
                                            <th class="text-center">
                                                <i class="fas fa-chart-bar me-1"></i>
                                                4-Week Total
                                                <br><small class="text-muted">Created / Merged</small>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for metric in metrics %}
                                            <tr>
                                                <td data-label="Repository">
                                                    <div class="d-flex align-items-center">
                                                        <i class="fab fa-github me-2 text-muted"></i>
                                                        <strong>{{ metric.repository }}</strong>
                                                    </div>
                                                </td>
                                                {% if metric.weekly_counts %}
                                                    {% for week in metric.weekly_counts %}
                                                        <td class="text-center" data-label="{{ week.week_label }}">
                                                            <div class="d-flex flex-column">
                                                                {% if week.total_prs >= 5 %}
                                                                    <span class="metric-badge high mb-1">{{ week.total_prs }} created</span>
                                                                {% elif week.total_prs >= 2 %}
                                                                    <span class="metric-badge medium mb-1">{{ week.total_prs }} created</span>
                                                                {% elif week.total_prs > 0 %}
                                                                    <span class="metric-badge neutral mb-1">{{ week.total_prs }} created</span>
                                                                {% else %}
                                                                    <span class="metric-badge low mb-1">{{ week.total_prs }} created</span>
                                                                {% endif %}
                                                                
                                                                {% if week.merged_prs >= 5 %}
                                                                    <span class="metric-badge high">{{ week.merged_prs }} merged</span>
                                                                {% elif week.merged_prs >= 2 %}
                                                                    <span class="metric-badge medium">{{ week.merged_prs }} merged</span>
                                                                {% elif week.merged_prs > 0 %}
                                                                    <span class="metric-badge neutral">{{ week.merged_prs }} merged</span>
                                                                {% else %}
                                                                    <span class="metric-badge low">{{ week.merged_prs }} merged</span>
                                                                {% endif %}
                                                            </div>
                                                        </td>
                                                    {% endfor %}
                                                {% else %}
                                                    {% for i in range(4) %}
                                                        <td class="text-center" data-label="Week {{ loop.index }}">
                                                            <div class="d-flex flex-column">
                                                                <span class="metric-badge low mb-1">0 created</span>
                                                                <span class="metric-badge low">0 merged</span>
                                                            </div>
                                                        </td>
                                                    {% endfor %}
                                                {% endif %}
                                                <td class="text-center" data-label="4-Week Total">
                                                    <div class="d-flex flex-column">
                                                        {% set total_created = metric.weekly_total_created or 0 %}
                                                        {% set total_merged = metric.weekly_total_merged or 0 %}
                                                        
                                                        {% if total_created >= 20 %}
                                                            <span class="metric-badge high mb-1">{{ total_created }} created</span>
                                                        {% elif total_created >= 10 %}
                                                            <span class="metric-badge medium mb-1">{{ total_created }} created</span>
                                                        {% elif total_created > 0 %}
                                                            <span class="metric-badge neutral mb-1">{{ total_created }} created</span>
                                                        {% else %}
                                                            <span class="metric-badge low mb-1">{{ total_created }} created</span>
                                                        {% endif %}
                                                        
                                                        {% if total_merged >= 20 %}
                                                            <span class="metric-badge high">{{ total_merged }} merged</span>
                                                        {% elif total_merged >= 10 %}
                                                            <span class="metric-badge medium">{{ total_merged }} merged</span>
                                                        {% elif total_merged > 0 %}
                                                            <span class="metric-badge neutral">{{ total_merged }} merged</span>
                                                        {% else %}
                                                            <span class="metric-badge low">{{ total_merged }} merged</span>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Charts -->
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-bar me-2"></i>
                                PR Throughput by Repository
                            </h5>
                            {% if overall_date_range and overall_date_range.has_data %}
                                <small class="text-muted">Data range: {{ overall_date_range.formatted_range }}</small>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="throughputChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-line me-2"></i>
                                MR Time by Repository
                            </h5>
                            {% if overall_date_range and overall_date_range.has_data %}
                                <small class="text-muted">Data range: {{ overall_date_range.formatted_range }}</small>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="mrTimeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-area me-2"></i>
                                First Commit to Merge Time by Repository
                            </h5>
                            {% if overall_date_range and overall_date_range.has_data %}
                                <small class="text-muted">Data range: {{ overall_date_range.formatted_range }}</small>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="commitToMergeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-calendar-week me-2"></i>
                                Weekly PR Activity Trend
                            </h5>
                            {% if overall_date_range and overall_date_range.has_data %}
                                <small class="text-muted">Data range: {{ overall_date_range.formatted_range }}</small>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="weeklyChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="card">
                                                 <div class="card-header">
                             <h5 class="card-title mb-0">
                                 <i class="fas fa-chart-bar me-2"></i>
                                 Top Contributors by Total PRs
                             </h5>
                             {% if overall_date_range and overall_date_range.has_data %}
                                 <small class="text-muted">Data range: {{ overall_date_range.formatted_range }}</small>
                             {% endif %}
                         </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="contributorsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="card">
                                                 <div class="card-header">
                             <h5 class="card-title mb-0">
                                 <i class="fas fa-chart-line me-2"></i>
                                 Average PR Size by Top Contributors
                             </h5>
                             {% if overall_date_range and overall_date_range.has_data %}
                                 <small class="text-muted">Data range: {{ overall_date_range.formatted_range }}</small>
                             {% endif %}
                         </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="prSizeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        {% else %}
            <div class="loading">
                <i class="fas fa-spinner fa-spin fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">Loading GitHub metrics...</h4>
                <p class="text-muted">Please wait while we fetch your repository data.</p>
            </div>
        {% endif %}
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center">
            <p>&copy; 2024 Developer Dashboard. Built with <i class="fas fa-heart text-danger"></i> for development teams.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    {% if metrics and chart_data_json %}
    <script>
        // Set chart data for external script
        window.chartData = {{ chart_data_json | safe }};
    </script>
    <script src="{{ url_for('static', filename='chart_script.js') }}"></script>
    {% endif %}

    <script>
        // Repository Collapse/Expand Functions
        function toggleRepoIcon(repoIndex) {
            const icon = document.getElementById(`repoIcon${repoIndex}`);
            const collapseElement = document.getElementById(`repoCollapse${repoIndex}`);
            
            // Toggle icon after Bootstrap collapse animation
            setTimeout(() => {
                if (collapseElement.classList.contains('show')) {
                    icon.className = 'fas fa-chevron-up toggle-icon';
                } else {
                    icon.className = 'fas fa-chevron-down toggle-icon';
                }
            }, 100);
        }
        
        function expandAllRepos() {
            const collapseElements = document.querySelectorAll('[id^="repoCollapse"]');
            const icons = document.querySelectorAll('[id^="repoIcon"]');
            
            collapseElements.forEach((element, index) => {
                if (!element.classList.contains('show')) {
                    const button = document.querySelector(`[data-bs-target="#${element.id}"]`);
                    if (button) {
                        button.click();
                    }
                }
            });
            
            // Update all icons after a delay to let animations complete
            setTimeout(() => {
                icons.forEach(icon => {
                    icon.className = 'fas fa-chevron-up toggle-icon';
                });
            }, 300);
        }
        
        function collapseAllRepos() {
            const collapseElements = document.querySelectorAll('[id^="repoCollapse"]');
            const icons = document.querySelectorAll('[id^="repoIcon"]');
            
            collapseElements.forEach((element, index) => {
                if (element.classList.contains('show')) {
                    const button = document.querySelector(`[data-bs-target="#${element.id}"]`);
                    if (button) {
                        button.click();
                    }
                }
            });
            
            // Update all icons after a delay to let animations complete
            setTimeout(() => {
                icons.forEach(icon => {
                    icon.className = 'fas fa-chevron-down toggle-icon';
                });
            }, 300);
        }

        // Cache management functions
        function loadCacheStats() {
            fetch('/api/cache-stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('cache-size').textContent = data.size || 0;
                    document.getElementById('cache-ttl').textContent = 
                        data.ttl_seconds ? `${data.ttl_seconds / 3600} Hour${data.ttl_seconds === 3600 ? '' : 's'}` : '12 Hours';
                    
                    // Update breakdown if available
                    if (data.breakdown) {
                        document.getElementById('cache-repo-metrics').textContent = data.breakdown.repo_metrics || 0;
                        // Combine team_default and team_month for team-specific cache count
                        const teamCacheCount = (data.breakdown.team_default || 0) + (data.breakdown.team_month || 0);
                        document.getElementById('cache-team-cache').textContent = teamCacheCount;
                        document.getElementById('cache-prs').textContent = data.breakdown.prs || 0;
                        document.getElementById('cache-all-reviews').textContent = data.breakdown.all_reviews || 0;
                        document.getElementById('cache-all-commits').textContent = data.breakdown.all_commits || 0;
                        document.getElementById('cache-detailed-prs').textContent = data.breakdown.detailed_prs || 0;
                        document.getElementById('cache-rate-limit').textContent = data.breakdown.rate_limit || 0;
                    }
                })
                .catch(error => {
                    console.error('Error loading cache stats:', error);
                    document.getElementById('cache-size').textContent = 'Error';
                });
        }

        function clearCache() {
            // Show the confirmation modal instead of browser alert
            const clearCacheModal = new bootstrap.Modal(document.getElementById('clearCacheModal'));
            clearCacheModal.show();
        }

        function confirmClearCache() {
            const teamName = '{{ team_name }}';
            
            // Hide the confirmation modal
            const clearCacheModal = bootstrap.Modal.getInstance(document.getElementById('clearCacheModal'));
            clearCacheModal.hide();
            
            // Perform the cache clear operation
            fetch(`/api/clear-cache/${encodeURIComponent(teamName)}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Show success modal
                        const successMessage = document.getElementById('cacheSuccessMessage');
                        successMessage.innerHTML = `Cache has been cleared for the <strong>${teamName}</strong> team. ${data.details}`;
                        
                        const cacheSuccessModal = new bootstrap.Modal(document.getElementById('cacheSuccessModal'));
                        cacheSuccessModal.show();
                        
                        // Reload cache stats
                        loadCacheStats();
                    } else {
                        // Show error modal
                        const errorMessage = document.getElementById('cacheErrorMessage');
                        errorMessage.textContent = data.error || 'Unknown error occurred while clearing cache.';
                        
                        const cacheErrorModal = new bootstrap.Modal(document.getElementById('cacheErrorModal'));
                        cacheErrorModal.show();
                    }
                })
                .catch(error => {
                    console.error('Error clearing cache:', error);
                    
                    // Show error modal
                    const errorMessage = document.getElementById('cacheErrorMessage');
                    errorMessage.textContent = error.message || 'Network error occurred while clearing cache.';
                    
                    const cacheErrorModal = new bootstrap.Modal(document.getElementById('cacheErrorModal'));
                    cacheErrorModal.show();
                });
        }

        function reloadPageAfterCacheClear() {
            // Hide the success modal and reload the page
            const cacheSuccessModal = bootstrap.Modal.getInstance(document.getElementById('cacheSuccessModal'));
            cacheSuccessModal.hide();
            
            // Small delay to ensure modal is hidden before reload
            setTimeout(() => {
                location.reload();
            }, 300);
        }

        // Load cache stats on page load
        document.addEventListener('DOMContentLoaded', loadCacheStats);

        // Date filter functionality
        let startDatePicker, endDatePicker;
        
        function initializeDatePickers() {
            // Initialize Flatpickr for start date
            startDatePicker = flatpickr("#start-date", {
                dateFormat: "Y-m-d",
                maxDate: "today",
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length > 0) {
                        // Update end date minimum to selected start date
                        endDatePicker.set('minDate', selectedDates[0]);
                        // Activate custom range filter
                        activateCustomRangeFilter();
                    }
                }
            });
            
            // Initialize Flatpickr for end date
            endDatePicker = flatpickr("#end-date", {
                dateFormat: "Y-m-d",
                maxDate: "today",
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length > 0) {
                        // Update start date maximum to selected end date
                        startDatePicker.set('maxDate', selectedDates[0]);
                        // Activate custom range filter
                        activateCustomRangeFilter();
                    }
                }
            });
        }
        
        function activateCustomRangeFilter() {
            // Clear month selector
            clearMonthFilterSilent();
            
            // Update visual states
            updateFilterStates('custom');
            
            // Update filter description
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            if (startDate && endDate) {
                updateFilterStatus(`Custom range: ${startDate} → ${endDate}`);
            } else if (startDate) {
                updateFilterStatus(`Custom range: From ${startDate}`);
            } else if (endDate) {
                updateFilterStatus(`Custom range: Until ${endDate}`);
            }
        }
        
        function activateMonthFilter() {
            // Clear custom date range
            clearDateFilterSilent();
            
            // Update visual states
            updateFilterStates('month');
            
            // Update filter description
            const monthSelector = document.getElementById('month-selector');
            const selectedText = monthSelector.options[monthSelector.selectedIndex]?.text;
            if (selectedText) {
                updateFilterStatus(`Quick month: ${selectedText}`);
            }
        }
        
        function updateFilterStates(activeFilter) {
            const customCard = document.getElementById('custom-range-card');
            const monthCard = document.getElementById('month-selector-card');
            const customBadge = document.getElementById('custom-range-badge');
            const monthBadge = document.getElementById('month-selector-badge');
            
            if (activeFilter === 'custom') {
                // Activate custom range
                customCard.classList.add('active');
                customCard.classList.remove('inactive');
                customBadge.style.display = 'inline-block';
                
                // Deactivate month selector
                monthCard.classList.remove('active');
                monthCard.classList.add('inactive');
                monthBadge.style.display = 'none';
            } else if (activeFilter === 'month') {
                // Activate month selector
                monthCard.classList.add('active');
                monthCard.classList.remove('inactive');
                monthBadge.style.display = 'inline-block';
                
                // Deactivate custom range
                customCard.classList.remove('active');
                customCard.classList.add('inactive');
                customBadge.style.display = 'none';
            } else {
                // Neither active
                customCard.classList.remove('active', 'inactive');
                monthCard.classList.remove('active', 'inactive');
                customBadge.style.display = 'none';
                monthBadge.style.display = 'none';
            }
        }
        
        // Toggle Filters Function
        function toggleFilters() {
            const filterContent = document.getElementById('filter-content');
            const toggleIcon = document.getElementById('filter-toggle-icon');
            const filterCount = document.getElementById('filter-count');
            const currentStatus = document.getElementById('current-filter-status');
            
            if (filterContent.style.display === 'none' || filterContent.style.display === '') {
                // Show filters
                filterContent.style.display = 'block';
                setTimeout(() => {
                    filterContent.style.opacity = '1';
                    filterContent.style.transform = 'translateY(0)';
                }, 10);
                toggleIcon.style.transform = 'rotate(180deg)';
                filterCount.textContent = 'Expanded';
                filterCount.className = 'badge bg-primary text-white ms-2';
            } else {
                // Hide filters
                filterContent.style.opacity = '0';
                filterContent.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    filterContent.style.display = 'none';
                }, 300);
                toggleIcon.style.transform = 'rotate(0deg)';
                
                // Update status based on current filter state
                const hasFilters = hasActiveFilters();
                if (hasFilters) {
                    filterCount.textContent = 'Active';
                    filterCount.className = 'badge bg-success text-white ms-2';
                } else {
                    filterCount.textContent = 'Optional';
                    filterCount.className = 'badge bg-light text-dark ms-2';
                }
            }
        }

        function populateMonthSelector() {
            const monthSelector = document.getElementById('month-selector');
            const currentDate = new Date();
            
            // Add change event listener for mutual exclusivity
            monthSelector.addEventListener('change', function() {
                if (this.value) {
                    activateMonthFilter();
                } else {
                    updateFilterStates('none');
                    updateFilterStatus('Showing all available data (last 20 PRs per repository)');
                }
            });
            
            // Generate last 12 months
            for (let i = 0; i < 12; i++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const year = date.getFullYear();
                const month = date.getMonth();
                
                const monthNames = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                
                const monthName = monthNames[month];
                const startDate = `${year}-${String(month + 1).padStart(2, '0')}-01`;
                const endDate = new Date(year, month + 1, 0).toISOString().split('T')[0];
                
                const option = document.createElement('option');
                option.value = `${startDate}|${endDate}`;
                option.textContent = `${monthName} ${year}`;
                monthSelector.appendChild(option);
            }
        }
        
        function applyDateFilter() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            showLoading();
            updateDateRangeDisplay(startDate, endDate);
            
            // Get current team name from URL
            const currentPath = window.location.pathname;
            const teamName = currentPath.split('/').pop();
            
            // Build URL with query parameters
            const params = new URLSearchParams();
            params.set('start_date', startDate);
            params.set('end_date', endDate);
            
            // Navigate to filtered URL
            window.location.href = `${currentPath}?${params.toString()}`;
        }
        
        function clearDateFilter() {
            clearDateFilterSilent();
            updateFilterStates('none');
            updateFilterStatus('Showing all available data (last 20 PRs per repository)');
            resetDateRangeDisplay();
        }
        
        function clearDateFilterSilent() {
            startDatePicker.clear();
            endDatePicker.clear();
        }
        
        function applyMonthFilter() {
            const monthSelector = document.getElementById('month-selector');
            const selectedValue = monthSelector.value;
            
            if (!selectedValue) {
                alert('Please select a month');
                return;
            }
            
            const [startDate, endDate] = selectedValue.split('|');
            
            showLoading();
            updateDateRangeDisplay(startDate, endDate);
            
            // Get current team name from URL
            const currentPath = window.location.pathname;
            
            // Build URL with query parameters
            const params = new URLSearchParams();
            params.set('start_date', startDate);
            params.set('end_date', endDate);
            
            // Navigate to filtered URL
            window.location.href = `${currentPath}?${params.toString()}`;
        }
        
        function clearMonthFilter() {
            clearMonthFilterSilent();
            updateFilterStates('none');
            updateFilterStatus('Showing all available data (last 20 PRs per repository)');
            resetDateRangeDisplay();
        }
        
        function clearMonthFilterSilent() {
            document.getElementById('month-selector').value = '';
        }
        
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'block';
        }
        
        function showParallelLoading() {
            document.getElementById('parallel-loading-overlay').style.display = 'block';
        }
        
        function hideParallelLoading() {
            document.getElementById('parallel-loading-overlay').style.display = 'none';
        }
        
        function navigateToTeamComparison(event) {
            // Prevent any potential loading screen interference
            event.preventDefault();
            
            // Hide any existing loading overlays
            const loadingOverlay = document.getElementById('loading-overlay');
            const parallelLoadingOverlay = document.getElementById('parallel-loading-overlay');
            
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
            if (parallelLoadingOverlay) {
                parallelLoadingOverlay.style.display = 'none';
            }
            
            // Show team comparison loading overlay
            const teamComparisonOverlay = document.getElementById('team-comparison-loading-overlay');
            if (teamComparisonOverlay) {
                teamComparisonOverlay.style.display = 'flex';
                // Force reflow to ensure display change is applied
                teamComparisonOverlay.offsetHeight;
                teamComparisonOverlay.style.opacity = '1';
            }
            
            // Add a small delay to ensure the loading overlay is visible
            // and animation completes before starting navigation (improves UX)
            setTimeout(() => {
                // Navigate to team comparison page
                window.location.href = '/team-comparison';
            }, 150);
        }
        
        function updateFilterStatus(description) {
            const filterDescription = document.getElementById('filter-description');
            if (filterDescription) {
                filterDescription.textContent = description;
            }
        }
        
        function updateDateRangeDisplay(startDate, endDate) {
            const dateRangeDisplay = document.getElementById('date-range-display');
            const dateRangeDays = document.getElementById('date-range-days');
            
            if (dateRangeDisplay && startDate && endDate) {
                // Format dates nicely
                const startFormatted = new Date(startDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                const endFormatted = new Date(endDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                // Calculate days between dates
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                
                dateRangeDisplay.textContent = `Data Range: ${startFormatted} – ${endFormatted}`;
                if (dateRangeDays) {
                    dateRangeDays.textContent = `(${diffDays} days)`;
                }
            }
        }
        
        function resetDateRangeDisplay() {
            // Navigate to URL without query parameters to reset to original state
            const currentPath = window.location.pathname;
            window.location.href = currentPath;
        }
        
        function hasActiveFilters() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const monthSelector = document.getElementById('month-selector').value;
            
            return (startDate && endDate) || monthSelector;
        }
        
        function getActiveFilterType() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const monthSelector = document.getElementById('month-selector').value;
            
            if (startDate || endDate) {
                return 'custom';
            } else if (monthSelector) {
                return 'month';
            }
            return 'none';
        }
        
        // Initialize date pickers and month selector on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeDatePickers();
            populateMonthSelector();
            
            // Set initial filter content styles for smooth transitions
            const filterContent = document.getElementById('filter-content');
            filterContent.style.opacity = '0';
            filterContent.style.transform = 'translateY(-10px)';
            filterContent.style.transition = 'all 0.3s ease';
            
            // Pre-fill date inputs if URL has parameters
            const urlParams = new URLSearchParams(window.location.search);
            const startDate = urlParams.get('start_date');
            const endDate = urlParams.get('end_date');
            
            if (startDate && endDate) {
                startDatePicker.setDate(startDate, false);
                endDatePicker.setDate(endDate, false);
                updateDateRangeDisplay(startDate, endDate);
                
                // Check if this matches a month selection
                const monthSelector = document.getElementById('month-selector');
                let foundMonth = false;
                
                for (let option of monthSelector.options) {
                    if (option.value) {
                        const [monthStart, monthEnd] = option.value.split('|');
                        if (monthStart === startDate && monthEnd === endDate) {
                            monthSelector.value = option.value;
                            updateFilterStates('month');
                            foundMonth = true;
                            break;
                        }
                    }
                }
                
                if (!foundMonth) {
                    updateFilterStates('custom');
                }
            } else if (startDate) {
                startDatePicker.setDate(startDate, false);
                updateFilterStates('custom');
            } else if (endDate) {
                endDatePicker.setDate(endDate, false);
                updateFilterStates('custom');
            } else {
                updateFilterStates('none');
            }
            
            // Update filter count badge based on initial state
            const hasFilters = hasActiveFilters();
            const filterCount = document.getElementById('filter-count');
            const currentStatus = document.getElementById('current-filter-status');
            
            if (hasFilters) {
                filterCount.textContent = 'Active';
                filterCount.className = 'badge bg-success text-white ms-2';
            } else {
                filterCount.textContent = 'Optional';
                filterCount.className = 'badge bg-light text-dark ms-2';
                if (currentStatus) {
                    currentStatus.textContent = 'Click to show filtering options';
                }
            }
            
            // Ensure team comparison loading overlay is hidden on page load
            const teamComparisonOverlay = document.getElementById('team-comparison-loading-overlay');
            if (teamComparisonOverlay) {
                teamComparisonOverlay.style.opacity = '0';
                teamComparisonOverlay.style.display = 'none';
            }
        });
        
        // Handle browser back button - hide team comparison overlay if visible
        window.addEventListener('pageshow', function(event) {
            const teamComparisonOverlay = document.getElementById('team-comparison-loading-overlay');
            if (teamComparisonOverlay && teamComparisonOverlay.style.display === 'flex') {
                teamComparisonOverlay.style.display = 'none';
                teamComparisonOverlay.style.opacity = '0';
            }
        });
    </script>

    <!-- Team Comparison Loading Overlay -->
    <div id="team-comparison-loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9999; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease-in-out;">
        <div style="text-align: center; color: #FFFFFF; background: linear-gradient(135deg, var(--sapphire-blue) 0%, var(--sapphire-secondary) 100%); padding: 3rem 2rem; border-radius: 12px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); max-width: 400px; width: 90%;">
            <div style="width: 60px; height: 60px; border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #FFFFFF; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1.5rem auto;"></div>
            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; color: #FFFFFF;">
                Comparing all teams...
            </div>
            <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0; color: #FFFFFF;">
                Analyzing cross-team performance metrics
            </div>
        </div>
    </div>

    <!-- Clear Cache Modal -->
    <div id="clearCacheModal" class="modal fade" tabindex="-1" aria-labelledby="clearCacheModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border: none; border-radius: 12px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);">
                <div class="modal-header" style="background: linear-gradient(135deg, #FF7043 0%, #D84315 100%); color: #FFFFFF; border-radius: 12px 12px 0 0; border: none;">
                    <h5 class="modal-title" id="clearCacheModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Clear Cache Confirmation
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="padding: 2rem; background: #FFFFFF;">
                    <div class="text-center mb-3">
                        <i class="fas fa-database fa-3x text-warning mb-3"></i>
                        <h6 class="text-primary mb-3">Are you sure you want to clear the cache?</h6>
                        <p class="text-muted mb-3">
                            This will remove all cached data for the <strong id="teamNameInModal">{{ team_name }}</strong> team.
                        </p>
                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> This action will force fresh data retrieval from GitHub API for better performance.
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="background: #F8F9FA; border-radius: 0 0 12px 12px; border: none; padding: 1.5rem 2rem;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>
                        Cancel
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmClearCache()">
                        <i class="fas fa-trash me-2"></i>
                        Clear Cache
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cache Success Modal -->
    <div id="cacheSuccessModal" class="modal fade" tabindex="-1" aria-labelledby="cacheSuccessModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border: none; border-radius: 12px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--success-color) 0%, var(--primary-color) 100%); color: #FFFFFF; border-radius: 12px 12px 0 0; border: none;">
                    <h5 class="modal-title" id="cacheSuccessModalLabel">
                        <i class="fas fa-check-circle me-2"></i>
                        Cache Cleared Successfully
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="padding: 2rem; background: #FFFFFF;">
                    <div class="text-center mb-3">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h6 class="text-primary mb-3">Cache cleared successfully!</h6>
                        <p class="text-muted mb-3" id="cacheSuccessMessage">
                            Cache has been cleared for the <strong>{{ team_name }}</strong> team.
                        </p>
                        <div class="alert alert-success" role="alert">
                            <i class="fas fa-rocket me-2"></i>
                            <strong>Next load:</strong> Fresh data will be fetched from GitHub API with parallel processing.
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="background: #F8F9FA; border-radius: 0 0 12px 12px; border: none; padding: 1.5rem 2rem;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>
                        Close
                    </button>
                    <button type="button" class="btn btn-primary" onclick="reloadPageAfterCacheClear()">
                        <i class="fas fa-sync me-2"></i>
                        Reload Page
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cache Error Modal -->
    <div id="cacheErrorModal" class="modal fade" tabindex="-1" aria-labelledby="cacheErrorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border: none; border-radius: 12px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);">
                <div class="modal-header" style="background: linear-gradient(135deg, #F44336 0%, #C62828 100%); color: #FFFFFF; border-radius: 12px 12px 0 0; border: none;">
                    <h5 class="modal-title" id="cacheErrorModalLabel">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Cache Clear Error
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="padding: 2rem; background: #FFFFFF;">
                    <div class="text-center mb-3">
                        <i class="fas fa-exclamation-circle fa-3x text-danger mb-3"></i>
                        <h6 class="text-primary mb-3">Error clearing cache</h6>
                        <p class="text-muted mb-3" id="cacheErrorMessage">
                            An error occurred while clearing the cache.
                        </p>
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-bug me-2"></i>
                            <strong>Troubleshooting:</strong> Please try again or contact support if the issue persists.
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="background: #F8F9FA; border-radius: 0 0 12px 12px; border: none; padding: 1.5rem 2rem;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>
                        Close
                    </button>
                    <button type="button" class="btn btn-warning" onclick="clearCache()">
                        <i class="fas fa-redo me-2"></i>
                        Try Again
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            #team-comparison-loading-overlay > div {
                padding: 2rem 1.5rem !important;
                max-width: 320px !important;
            }
            
            #team-comparison-loading-overlay > div > div:first-child {
                width: 50px !important;
                height: 50px !important;
                border-width: 3px !important;
            }
            
            #team-comparison-loading-overlay > div > div:nth-child(2) {
                font-size: 1rem !important;
            }
            
            #team-comparison-loading-overlay > div > div:nth-child(3) {
                font-size: 0.85rem !important;
            }
        }
    </style>
</body>
</html> 